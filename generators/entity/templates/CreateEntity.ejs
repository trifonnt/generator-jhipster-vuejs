<% include fns.ejs %>

<template>
  <v-app id="inspire">
    <v-content>
      <v-container fluid fill-height>
        <v-layout justify-center>
          <v-flex xs12 sm8 md4>
            <v-card class="elevation-12">
              <v-toolbar dark color="primary">

                <v-toolbar-title>{{$t('<%=firstToLower(name)%>.<%=baseNameApp%>.<%=firstToLower(name)%>.home.createOrEditLabel')}}</v-toolbar-title>
                <v-spacer></v-spacer>

              </v-toolbar>
                            <v-card-text>
                <v-form @submit.prevent='create'>
                  <% 
                  fields[0].focus = true;
                  fields.forEach(field=>{
                    let validate = {};
                    let req = false;
                    let fName = field.fieldName;
                    let fType = field.fieldType;
                    if(field.fieldValidateRules && field.fieldValidateRules.includes('required')) {
                      validate.required = true;
                      req = true;
                    }
                    if("fieldValidateRulesMinlength" in field) {
                      validate.min=field.fieldValidateRulesMinlength;
                    }
                    if("fieldValidateRulesMaxlength" in field) {
                      validate.max=field.fieldValidateRulesMaxlength;
                    }
                    if("fieldValidateRulesPattern" in field) {
                      validate.pattern = field.fieldValidateRulesPattern;
                    }
                    //if(fType == "Boolean") validate.boolean = true;
                    if(fType == "String") validate["alpha_dash"] = true;
                    if(['Integer', 'BigDecimal', 'Long'].includes(fType)) validate.integer = true;
                    if(['Float', 'Double'].includes(fType)) validate.regex = /^(?:\d+|\d{1,3}(?:,\d{3})+)(?:(\.|,)\d+)?/;
                    validate = JSON.stringify(validate)
                  %>
                    <% if(['Integer', 'BigDecimal', 'Long', 'Float', 'Double'].includes(fType) && field.fieldValues == undefined) {%>
                      <v-text-field :readonly='isReadOnly("<%=field.readonlyForRoles%>")' v-hasRole="'<%=field.visibleForRole%>'" <%if(req) {%> prepend-inner-icon='*' <%}%> <%if(field.focus){%> autofocus <%}%>  v-validate='<%-validate%>' name="<%=fName%>" :label="$t('<%=firstToLower(name)%>.<%=baseNameApp%>.<%=firstToLower(name)%>.<%=fName%>')" type="text" v-model="<%=fName%>"></v-text-field>
                      <v-alert v-hasRole="'<%=field.visibleForRole%>'" :value="errors.has('<%=fName%>')" type="error">{{ errors.first('<%=fName%>') }}</v-alert>  
                    <% }%>

                    <% if(fType=="String" && field.fieldValues == undefined) {%>
                      <v-text-field :readonly='isReadOnly("<%=field.readonlyForRoles%>")' v-hasRole="'<%=field.visibleForRole%>'" <%if(req) {%> prepend-inner-icon='*' <%}%> <%if(field.focus){%> autofocus <%}%> name="<%=fName%>" :label="$t('<%=firstToLower(name)%>.<%=baseNameApp%>.<%=firstToLower(name)%>.<%=fName%>')" type="text" v-model="<%=fName%>"></v-text-field>
                      <v-alert v-hasRole="'<%=field.visibleForRole%>'" :value="errors.has('<%=fName%>')" type="error">{{ errors.first('<%=fName%>') }}</v-alert>  
                    <% }%>
                    <% if(fType=="byte[]" && (field.fieldTypeBlobContent == 'any' || field.fieldTypeBlobContent == 'image')) { %>
                        <input :readonly='isReadOnly("<%=field.readonlyForRoles%>")' v-hasRole="'<%=field.visibleForRole%>'" name="<%=fName%>" type="file" multiple="multiple" @input="upload($event)">
                        <v-alert v-hasRole="'<%=field.visibleForRole%>'" :value="errors.has(<%=fName%>)" type="error">{{ errors.first(name) }}</v-alert>
                        <v-chip v-hasRole="'<%=field.visibleForRole%>'"><a :href='<%=fName%>' download>Download file</a> <v-btn icon @click='<%=fName%>=""'><v-icon>delete</v-icon></v-btn></v-chip>
                    <% } %>
                    <% if(fType == "Boolean") {%>
                      <v-checkbox :readonly='isReadOnly("<%=field.readonlyForRoles%>")' v-hasRole="'<%=field.visibleForRole%>'" <%if(field.focus){%> autofocus <%}%>  v-model='<%=fName%>' :label="$t('<%=firstToLower(name)%>.<%=baseNameApp%>.<%=firstToLower(name)%>.<%=fName%>')" name='<%=fName%>'></v-checkbox>
                      <v-alert v-hasRole="'<%=field.visibleForRole%>'" :value="errors.has('<%=fName%>')" type="error">{{ errors.first('<%=fName%>') }}</v-alert>
                    <% } %>
                    <% if(['LocalDate','ZonedDateTime'].includes(fType)) {%>
                      <v-menu :disabled='isReadOnly("<%=field.readonlyForRoles%>")' v-hasRole="'<%=field.visibleForRole%>'"
                          ref="menu<%=fName%>"
                          :close-on-content-click="false"
                          v-model="menu<%=fName%>"
                          :nudge-right="40"
                          :return-value.sync="<%=fName%>"
                          lazy
                          transition="scale-transition"
                          offset-y
                          full-width
                          min-width="290px"
                        >
                          <v-text-field
                            slot="activator"
                            v-model="<%=fName%>"
                            label="$t('<%=firstToLower(name)%>.<%=baseNameApp%>.<%=firstToLower(name)%>.<%=fName%>')"
                            prepend-icon="event"
                            readonly
                          ></v-text-field>
                          <v-date-picker v-model="<%=fName%>" @input="$refs.menu<%=fName%>.save(<%=fName%>)"></v-date-picker>

                        </v-menu>
                        <v-alert v-hasRole="'<%=field.visibleForRole%>'" :value="errors.has('<%=fName%>')" type="error">{{ errors.first('<%=fName%>') }}</v-alert>
                    <% } %>
                    <% if(fType == 'Instant') { %>
                      <datetime v-hasRole="'<%=field.visibleForRole%>'" type='datetime' v-model="<%=fName%>" input-id="<%=fName%>" input-class='borderField'>
                          <label for="<%=fName%>" slot="before">{{$t('<%=firstToLower(name)%>.<%=baseNameApp%>.<%=firstToLower(name)%>.<%=fName%>')}}</label>
                      </datetime>   
                    <% } %>
                    <% if(fType == "String" && field.fieldValues != undefined) {%>
                      <v-select :readonly='isReadOnly("<%=field.readonlyForRoles%>")' v-hasRole="'<%=field.visibleForRole%>'" <%if(field.focus){%> autofocus <%}%>  :items='<%=addS(fName)%>' solo v-validate='<%-validate%>' name="<%=fName%>" :label="$t('<%=firstToLower(name)%>.<%=baseNameApp%>.<%=firstToLower(name)%>.<%=fName%>')" v-model="<%=fName%>"></v-select>
                      <v-alert v-hasRole="'<%=field.visibleForRole%>'" :value="errors.has('<%=fName%>')" type="error">{{ errors.first('<%=fName%>') }}</v-alert>
                    <% } %>
                  <% if(fType == 'Html' || fType == 'byte[]' && field.fieldTypeBlobContent == 'text') {%>
                      {{$t('<%=firstToLower(name)%>.<%=baseNameApp%>.<%=firstToLower(name)%>.<%=fName%>')}}
                      <br/>
                      <quill-editor v-hasRole="'<%=field.visibleForRole%>'" ref="quillEditor<%=fName%>"
                        v-model="<%=fName%>"
                        :options="editorOptions">
                      </quill-editor>
                  <% } %>
                  <%})%>
                  <% for(relationship of relationships) { 
                    let multiple = false;
                    if(!(relationship.relationshipType == 'many-to-many' && relationship.ownerSide==false)) {
                    if(relationship.relationshipType == 'many-to-many') multiple=true;

                    let validate = {};
                    let fName = relationship.relationshipName;
                    let fType = relationship.relationshipType;
                    let req = false;
                    if(relationship.relationshipValidateRules && relationship.relationshipValidateRules.includes('required')) {
                      validate.required = true;
                      req = true;
                    }
                    if("relationshipValidateRulesMinlength" in relationship) {
                      validate.min=relationship.relationshipValidateRulesMinlength;
                    }
                    if("relationshipValidateRulesMaxlength" in relationship) {
                      validate.max=relationship.relationshipValidateRulesMaxlength;
                    }
                    if("relationshipValidateRulesPattern" in relationship) {
                      validate.pattern = relationship.fieldValidateRulesPattern;
                    }
                    if(fType == "Boolean") validate.boolean = true;
                    if(fType == "String") validate["alpha_dash"] = true;
                    if(['Integer', 'BigDecimal', 'Long'].includes(fType)) validate.integer = true;
                    if(['Float', 'Double'].includes(fType)) validate.regex = /^(?:\d+|\d{1,3}(?:,\d{3})+)(?:(\.|,)\d+)?/;
                    validate = JSON.stringify(validate)
                    let model = fName;
                    if(relationship.relationshipType == 'many-to-many' || relationship.relationshipType == 'one-to-many') {
                      model = fName+'Values';
                    }
                  %>
 <!--                      <v-select <%if(relationship.focus){%> autofocus <%}%> <%if(multiple){%> multiple return-object <%}%> :items='<%=addS(fName)%>' solo v-validate='<%-validate%>' name="<%=fName%>" :label="$t('<%=firstToLower(name)%>.<%=baseNameApp%>.<%=firstToLower(name)%>.<%=fName%>')" v-model="<%=fName%>"
                        item-text='<%=relationship.otherEntityField%>' item-value='id'
                        ></v-select>


 -->
                        <%if(relationship.otherEntityName2) {%>
                        <v-autocomplete :readonly='isReadOnly("<%=relationship.readonlyForRoles%>")' v-hasRole="'<%=relationship.visibleForRole%>'"
                          <%if(multiple){%> multiple return-object <%}%> 
                          <%if(req) {%> prepend-inner-icon='*' <%}%>
                          :items='<%=addS(fName)%>'
                          :search-input.sync="<%=fName%>search"
                          v-validate='<%-validate%>' 
                          name="<%=fName%>" 
                          :label="$t('<%=firstToLower(name)%>.<%=baseNameApp%>.<%=firstToLower(name)%>.<%=fName%>')"
                          v-model="<%=model%>"
<!--                           item-text='<%=relationship.otherEntityField%>' 
                          item-value='id' -->
                          :filter="v => v"
                        >
                        <template slot="item" slot-scope="{item}">
                          <div class='leftcol'>{{item.<%=relationship.otherEntityName%>.substr(0,20)}}</div> <div class='rightcol'>{{item.<%=relationship.otherEntityName2%>}}</div>
                        </template>

                        </v-autocomplete>
                      <% } else { %>
                        <v-autocomplete :readonly='isReadOnly("<%=relationship.readonlyForRoles%>")' v-hasRole="'<%=relationship.visibleForRole%>'"
                          <%if(multiple){%> multiple return-object <%}%> 
                          <%if(req) {%> prepend-inner-icon='*' <%}%>
                          :items='<%=addS(fName)%>'
                          :search-input.sync="<%=fName%>search"
                          v-validate='<%-validate%>' 
                          name="<%=fName%>" 
                          :label="$t('<%=firstToLower(name)%>.<%=baseNameApp%>.<%=firstToLower(name)%>.<%=fName%>')"
                          v-model="<%=model%>"
                          item-text='<%=relationship.otherEntityField%>' 
                          item-value='id'
                        ></v-autocomplete>
                      <% } %>

                      <v-alert v-hasRole="'<%=relationship.visibleForRole%>'" :value="errors.has('<%=fName%>')" type="error">{{ errors.first('<%=fName%>') }}</v-alert>
                  <% } } %>
        
             <!--    <v-alert type='success' :value="registered==true">You successfully created a vendor</v-alert>
                <v-alert type='error' :value="registered==false">Please try again, server error</v-alert>  -->               
                </v-form>
              </v-card-text>
              <v-card-actions>
                <v-spacer></v-spacer>
                <v-btn :disabled="errors.any()" color="primary" @click='edit'>{{$t('<%=firstToLower(name)%>.<%=baseNameApp%>.<%=firstToLower(name)%>.home.createOrEditLabel')}}</v-btn>
                <v-btn @click='cancel'>{{$t('app.cancel')}}</v-btn>
              </v-card-actions>
            </v-card>
          </v-flex>
        </v-layout>
      </v-container>
    </v-content>
  </v-app>
</template>

<script>
  import {getProfile} from '../../../store/identity'
  
  let store = require('../../../store/<%=toLower(name)%>').default;
  <% for(relationship of relationships) {%>
    let get<%=addS(firstToUpper(relationship.relationshipName))%> = store.get<%=addS(firstToUpper(relationship.relationshipName))%>
  <% } %> 
    let create = store.create;
    let getEntityByTemplate = store.getEntityByTemplate;    
    export default {
    inject: ['$validator'],
    data: () => ({
      editorOptions: {
        modules: {
          toolbar: [
            ['bold', 'italic', 'underline', 'strike'],
            ['blockquote', 'code-block'],
            [{ 'header': 1 }, { 'header': 2 }],
            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            [{ 'script': 'sub' }, { 'script': 'super' }],
            [{ 'indent': '-1' }, { 'indent': '+1' }],
            [{ 'direction': 'rtl' }],
            [{ 'size': ['small', false, 'large', 'huge'] }],
            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
            [{ 'font': [] }],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'align': [] }],
            ['clean'],
          ],
        }
      },
      registered: null,
      <% fields.forEach(field=>{%>
        <%
          let fType = field.fieldType;
          let val;
          if(fType == 'String') val = '""';
          if(fType == 'Boolean') val = "''";
          if(['Integer','BigDecimal','Long','Float','Double', 'LocalDate', 'Instant', 'ZonedDateTime','String', 'byte[]'].includes(fType)) {
            val = '""';
        %>
          <% 
            if(['LocalDate', 'Instant', 'ZonedDateTime'].includes(fType)) {
          %>
            menu<%=field.fieldName%>: '',
          <% } %>
          <% if(fType == 'byte[]') { %>
          <%=field.fieldName%>ContentType: '""',
          <% } %>
        <%=field.fieldName%>: <%-val%>,
        <%
          }
          if(fType == 'String' && field.fieldValues != undefined) {
            val = field.fieldValues.split(',')
        %>
        <%=field.fieldName%> : [],
        <%=addS(field.fieldName)%>: [
          <%for(val of field.fieldValues.split(',')) {%>
            "<%=val%>",
          <% } %>
        ],
        <%
          }
        %>
      <%})%>
      <% if(relationships.length) { %>
        <% for(relationship of relationships) { %>
          <%=relationship.relationshipName%>search: '',
          <%=pluralize(relationship.relationshipName)%>: [],
          <%
            if(relationship.relationshipType=='many-to-many') {
          %>
          <%=relationship.relationshipName%>:[],
          <%=relationship.relationshipName%>Values:[],
          <% } else {%>
          <%=relationship.relationshipName%>: '',
          <% } %>
        <% } %>
      <% } %>

    }),
    created() {
      this.getData();
    },
    methods: {
      isReadOnly(roles) {
        if(roles == "false" || !roles) return false;
        if(!roles.length) return roles;
        if(roles.includes(',') 
          && roles.split(',').every(r=>!getProfile().roles.includes(r)).length==0) return false;
        else if(!roles.includes(',') && getProfile().jwt && getProfile().roles[0]!=roles) return false;
        return true
      },
      readFile(file) {
        return new Promise((resolve, reject) => {
          let reader = new FileReader();
          reader.onload = () => {
            resolve(reader.result);
          };
          reader.onerror = reject;
          reader.readAsDataURL(file)
        })
      },
      upload(e) {
        let files = e.target.files;
        let p = Promise.resolve();
        let parr = Object.keys(files).map(file=>p.then(()=>this.readFile(files[file])));
        Promise.all(parr).then(result=>{
          let data = result[0].split(";base64,");
          this[e.target.name] = data[1];
          this[e.target.name+"ContentType"] = data[0].split(":")[1];
        })
      },
      async edit() {
        try {
/*          let res = await edit({
            id: this.$route.params.id,
            <% for(field of fields) { %>
              <%=field.fieldName%>:this.<%=field.fieldName%>, 
            <% } %>
            <% for(relationship of relationships) { %>
              <%
                if(relationship.relationshipType=='many-to-many') {
              %>
              <%=pluralize(relationship.relationshipName)%>: this.<%=relationship.relationshipName%>Values,
              <% } %>
              <%=relationship.relationshipName%>Id:this.<%=relationship.relationshipName%>, 
            <% } %>
          });*/
          let res = await create({
            <% for(field of fields) { %>
              <%=field.fieldName%>:this.<%=field.fieldName%>,
              <% if(field.fieldType == 'byte[]') { %>
                <%=field.fieldName%>ContentType = this.<%=field.fieldName%>ContentType,
              <% } %>
            <% } %>
            <% for(relationship of relationships) { %>
              <%
                if(relationship.relationshipType=='many-to-many') {
              %>
              <%=pluralize(relationship.relationshipName)%>: this.<%=relationship.relationshipName%>,
              <% } %>
              <%=relationship.relationshipName%>Id:this.<%=relationship.relationshipName%>, 
            <% } %>
          });
          this.$store.dispatch('snackShowAction', {text: this.$t('<%=firstToLower(name)%>.<%=baseNameApp%>.<%=firstToLower(name)%>.created', {id: res.id}), val: true, color: "success"})
          this.registered = true
          this.$router.go(-1);
        }
        catch(err) {
          this.$store.dispatch('snackShowAction', {text: res.title, val: true, color: "error"})          
          this.registered = false
        }
      },
      cancel() {
        this.$router.go(-1);
      },
      async getData() {
        try {
          let [
            <% for(relationship of relationships) {
              if(!(relationship.relationshipType == 'many-to-many' && relationship.ownerSide==false)) {
            %>
              <%=relationship.relationshipName%>,
            <% } } %> entity] = await Promise.all([
                <% for(relationship of relationships) {
                  if(!(relationship.relationshipType == 'many-to-many' && relationship.ownerSide==false)) {
                %>
                  get<%=addS(firstToUpper(relationship.relationshipName))%>(),
                <% } }%> 
                getEntityByTemplate()
              ]);
          <% for(field of fields) { %>
            this.<%=field.fieldName%> = entity.<%=field.fieldName%>;
            <% if(field.fieldType == 'byte[]') { %>
            this.<%=field.fieldName%>ContentType = entity.<%=field.fieldName%>ContentType
            <% } %>
          <% } %>
          <% for(relationship of relationships) { 
            if(!(relationship.relationshipType == 'many-to-many' && relationship.ownerSide==false)) {
          %>
              <%
                if(relationship.relationshipType == 'many-to-many') {
              %>
                this.<%=relationship.relationshipName%>Values = entity.<%=pluralize(relationship.relationshipName)%>
              <% } else  { %>
              this.<%=relationship.relationshipName%> = entity.<%=relationship.relationshipName%>Id
              <% } %>
              this.<%=pluralize(relationship.relationshipName)%> = <%=relationship.relationshipName%>
          <% } } %>
        }
        catch(err) {console.log(err)}
      },
    }
  }
</script>
<style scoped>
  .leftcol {
    width:200px;
    float: left;
  }
  .rightcol {
    width: 200px;
    float: right;
  }
</style>